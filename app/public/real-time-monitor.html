<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Device Monitor</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .monitor { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .device-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .device-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-active { background: #4CAF50; color: white; }
        .status-inactive { background: #f44336; color: white; }
        .status-maintenance { background: #FF9800; color: white; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 10px; border-radius: 4px; }
        .connected { background: #4CAF50; color: white; }
        .disconnected { background: #f44336; color: white; }
        .last-seen { color: #666; font-size: 12px; }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Connecting...</div>
    
    <h1>Real-time Device Monitor</h1>
    <div id="deviceCount">Loading devices...</div>
    
    <div class="monitor" id="deviceMonitor">
        <!-- Device cards will be populated here -->
    </div>

    <script>
        let ws;
        let devices = new Map();
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => {
                updateConnectionStatus(true);
                console.log('WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = () => {
                updateConnectionStatus(false);
                console.log('WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }
        
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'connected':
                    subscribeToAllDevices();
                    break;
                case 'deviceUpdate':
                    updateDeviceStatus(data.deviceId, data.status);
                    break;
            }
        }
        
        function subscribeToAllDevices() {
            // Subscribe to updates for all devices
            fetch('/api/devices/api')
                .then(response => response.json())
                .then(deviceList => {
                    deviceList.forEach(device => {
                        devices.set(device._id, device);
                        ws.send(JSON.stringify({
                            type: 'subscribe',
                            deviceId: device._id
                        }));
                    });
                    renderDevices();
                })
                .catch(error => console.error('Failed to load devices:', error));
        }
        
        function updateDeviceStatus(deviceId, status) {
            if (devices.has(deviceId)) {
                const device = devices.get(deviceId);
                Object.assign(device, status);
                devices.set(deviceId, device);
                renderDevices();
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = connected ? 'Connected' : 'Disconnected';
            statusEl.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
        }
        
        function renderDevices() {
            const container = document.getElementById('deviceMonitor');
            const countEl = document.getElementById('deviceCount');
            
            countEl.textContent = `Monitoring ${devices.size} devices`;
            
            container.innerHTML = Array.from(devices.values()).map(device => `
                <div class="device-card">
                    <h3>${device.name || 'Unnamed Device'}</h3>
                    <p><strong>Phone:</strong> ${device.phoneNumber}</p>
                    <p><strong>Status:</strong> <span class="device-status status-${device.status}">${device.status.toUpperCase()}</span></p>
                    <p><strong>Location:</strong> ${device.area?.center ? `${device.area.center.latitude.toFixed(4)}, ${device.area.center.longitude.toFixed(4)}` : 'Unknown'}</p>
                    <p class="last-seen"><strong>Last Seen:</strong> ${new Date(device.lastSeen).toLocaleString()}</p>
                </div>
            `).join('');
        }
        
        // Initialize WebSocket connection
        connectWebSocket();
    </script>
</body>
</html>
